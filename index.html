<!DOCTYPE html>
<html>

<head>
  <meta http-equiv="Content-Type" charset="utf-8" name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="elab2ARC">
  <meta name="keywords" content="elab2ARC">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <style>
    .center {
      position: relative;
      text-align: center;
    }



    .uploadarea {

      padding: 6px;
      border: 4px solid #4fb3d9;
      border-style: outset;
      border-radius: 5px;
      -khtml-opacity: 0.5;
      -moz-opacity: 0.5;
      opacity: 0.5;
      height: 20vh;
      background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%234fb3d9' class='bi bi-cloud-upload' viewBox='0 0 16 16'><path fill-rule='evenodd' d='M4.406 1.342A5.53 5.53 0 0 1 8 0c2.69 0 4.923 2 5.166 4.579C14.758 4.804 16 6.137 16 7.773 16 9.569 14.502 11 12.687 11H10a.5.5 0 0 1 0-1h2.688C13.979 10 15 8.988 15 7.773c0-1.216-1.02-2.228-2.313-2.228h-.5v-.5C12.188 2.825 10.328 1 8 1a4.53 4.53 0 0 0-2.941 1.1c-.757.652-1.153 1.438-1.153 2.055v.448l-.445.049C2.064 4.805 1 5.952 1 7.318 1 8.785 2.23 10 3.781 10H6a.5.5 0 0 1 0 1H3.781C1.708 11 0 9.366 0 7.318c0-1.763 1.266-3.223 2.942-3.593.143-.863.698-1.723 1.464-2.383'/><path fill-rule='evenodd' d='M7.646 4.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 5.707V14.5a.5.5 0 0 1-1 0V5.707L5.354 7.854a.5.5 0 1 1-.708-.708z'/></svg>");
      background-position: center;
      background-repeat: no-repeat;
      background-size: 64px 64px;

    }

    td {
      overflow-wrap: break-all;
      word-break: break-all;
    }

    datalist {
      display: flex;
      justify-content: space-between;
      color: #4fb3d9;
      width: 100%;
    }

    .uploadarea:hover,
    .uploadarea.dragging,
    .uploadarea.uploading {
      filter: alpha(opacity=100);
      -khtml-opacity: 1;
      -moz-opacity: 1;
      opacity: 1;
    }

    .uploadarea input {
      margin: auto;
      width: 100%;
      height: 100%;

      border: none;
      cursor: pointer;
      opacity: 0;
    }

    .uploadarea input:focus {
      outline: none;
    }

    span.json {
      display: inline-block;

      margin: 4px;
      padding: 6px;
      border: 4px solid #4fb3d9;
      border-style: solid;
      border-radius: 5px;
    }

    *[title]:hover:after {
      background-color: #4fb3d9;
      content: attr(name) '\A' attr(description);
      z-index: 1;
      position: absolute;

    }

    span.studies {
      background-color: #fff9e6;

    }

    span.collapsed {
      font-weight: bold;
      border: 4px #4fb3d9;
      border-style: inset;
      box-shadow: 0 8px 6px -6px #4fb3d9;
      cursor: pointer;
    }

    span.missingKey {
      font-weight: bold;
      border: 4px #b005ad;
      border-style: dotted;
      box-shadow: 0 8px 6px -6px #c50070;
    }

    span.collapsed::before {
      content: "+";
      color: #4fb3d9;
    }

    span.assays {
      background-color: #F8E8EB;

    }

    .form-range {
      appearance: auto !important;
    }

    input[type="range"]::-webkit-slider-thumb {

      height: 15px;
      width: 15px;
      background-color: #fff;
      border-radius: 50%;
      border: 2px solid #4fb3d9;

    }

    input[type="range"]::-moz-range-thumb {
      height: 15px;
      width: 15px;
      background-color: #fff;
      border-radius: 50%;
      border: 1px solid #4fb3d9;


    }

    input[type="range"]::-moz-range-track {
      padding: 0 10px;
      background: repeating-linear-gradient(to right,
          #ccc,
          #ccc 10%,
          #000 10%,
          #000 11%,
          #ccc 11%,
          #ccc 20%);
    }

    .scrollTable{
      max-height : 200px;
      overflow-y: scroll;
      max-width: 80vw;
    }
  </style>

  
  <link href="./css/bootstrap.min.css" rel="stylesheet">
  <script src="./js/bootstrap.bundle.min.js"></script>
  <link href="./css/custom2607.css" rel="stylesheet" />
  <link href="./css/bs5-intro-tour.css" rel="stylesheet" />
  <script src="./js/bs5-intro-tour.js" type="text/javascript" charset="utf-8"></script>
  <script src="./js/git.js"></script>
  <script src="./js/main.js" type="text/javascript"></script>
  <script type="module">
    import http from './js/http.js'
    window.http = http;
    // window.fs = new LightningFS('fs')
    // window.pfs = window.fs.promises
  </script>


</head>

<body>
  <div class="col-12" style="background: rgb(45, 62, 80); height: 3.25rem; margin: 0 0 0 0px; padding: 0 0 0 0; ">
    <a class="" href="https://nfdi4plants.org/" style="">
      <img src="images/logo.png" alt="Logo" width="32" height="32"
        style="position: absolute; margin: 8px 12px 8px 12px; left: 0px; padding-top: 4px;" />
    </a>
    <div class="justify-content-center row d-flex align-items-center"
      style="margin: 0 0 0 0; ; padding: 0 0 0 0; height: 3.25rem;  ">


      <div class="btn-group d-md-none g-0 dropdown col-auto d-flex align-items-center" style="">
        <button type="button" class="btn rounded-0 border-0 g-0 btn-nav " data-bs-toggle="dropdown"
          aria-expanded="false" id="menu">
          Menu &nbsp;
          <a
            style="display: inline-block; color: rgb(79, 179, 217); letter-spacing: 2px; font-size: 1em; transform: scaleX(2); transform-origin: 1 0;">
            ∨ </a>
        </button>
        <ul class="dropdown-menu">
          <li>
            <button id="convertershort" class="dropdown-item d-none" onclick=''>Converter</button>
          </li>
          <li>
            <a id="ghlinkshort" class="dropdown-item" href="elab2ARC">GitHub</a>
          </li>
          <li>
            <a id="usshort" class="dropdown-item" onclick=''>About Us</a>
          </li>

        </ul>
      </div>

      <div class="btn-group d-none g-0 d-md-block dropdown col-auto">
        
        <button type="button" onclick="location.href=location.href.split('#')[0]+'#elab'" class="btn  btn-nav"
        id="submitNavBtn">
        Fetch eLabFTW &nbsp;
      </button>
        
        <button type="button" onclick="location.href=location.href.split('#')[0]+'#arc'" class="btn btn-nav"
          id="a2jNavBtn">
          Fetch ARCs&nbsp;
        </button>
        


        <button type="button" onclick="location.href=location.href.split('#')[0]+'#submit'" class="btn  btn-nav"
          id="isacheckNavBtn">
          Update ARC and Resubmit &nbsp;
        </button>

        <button type="button" class="btn border-0 rounded-0 g-0 btn-nav" data-bs-toggle="dropdown" aria-expanded="false"
          id="conversion_tools">
          Menu &nbsp;

          <a
            style="display: inline-block; color: rgb(79, 179, 217); letter-spacing: 2px; font-size: 1em; transform: scaleX(2); transform-origin: 1 0;">
            ∨ </a>
        </button>
        <ul class="dropdown-menu">
          <li>
            <button id="converterlong" class="dropdown-item d-none" onclick=''>Converter</button>
          </li>
          <li>
            <a id="ghlinklong" class="dropdown-item" href="elab2ARC">GitHub</a>
          </li>
          <li>
            <a id="aboutlong" class="dropdown-item" href=''>About</a>
          </li>
        </ul>
      </div>
    </div>
  </div>
  <div class="container">
    <div name="tab" class=" col-12 justify-content-center nav-link text-center" id="introTab">
      <a href="#elab">
        <h1>Fetch eLabFTW experiments </h1>
      </a>
      <a href="#arc">
        <h1>Fetch ARCs from DataHub </h1>
      </a>
      <a href="#submit">
        <h1>Update ARC and push to DataHub </h1>
      </a>
     
    </div>

    <div name="tab" class="row justify-content-center d-none" id="elabTab">
      <h1 class="center"> Collect eLabFTW Experiment </h1>


      <form id="authForm" class="row justify-content-center">
        <div class="mb-3 col-2">
          <label for="elabexperimentid" class="form-label">Experiment ID</label>
          <input type="text" class="form-control" id="elabexperimentid" aria-describedby="elabexpHelp">
          <div id="elabexpHelp" autocomplete="on" class="form-text d-none">Experiment ID can be found in the address bar of the browser.
          </div>
        </div>
        <div class="mb-3 col-2">
          <label for="elabToken" class="form-label">eLabFTW Access Token</label>
          <input type="text" autocomplete="on" class="form-control" id="elabToken">
        </div>

        <div class="mb-3 col-2">
          <label for="datahubToken" class="form-label">DataHub Access Token</label>
          <input type="password" autocomplete="on" class="form-control" id="datahubToken">
        </div>
        <div class="mb-3 col-3">
          <label for="elabsubmit" class="form-label">One click submit or progressive</label>
          <button class="btn btn-primary" type="submit" onclick="updateAll()" id="elabsubmit" > Submit </button>
          
        </div>
        
      </form>
      <div class="col-6 m-auto">
      
      </div>
      <div class="row justify-content-center m-3">
        <img id="bbb"></img>
      </div>
      
    </div>

    <div name="tab" class=" col-12 d-none" id="arcTab">
      <div class="" style="height: 50vh; overflow-y: scroll">

        <table class="table table-striped table-hover" style="table-layout:auto ; width:100%; ">
          <thead>
            <tr>
              <th scope="col">Number</th>
              <th scope="col">User/Group</th>
              <th scope="col">Repo Name</th>
              <th scope="col">Actions</th>
            </tr>
          </thead>
          <tbody id="datahubTable">
          </tbody>
        </table>
      </div>
      <div class="row m-3">
        <div class="col-5">
          <h4> Imported ARCs </h4>
          <table class="table table-striped table-hover" style="table-layout:auto ; width:100%; ">
            <thead>
              <tr>
                <th scope="col">ARC Name</th>
                <th scope="col">Import Time</th>
                <th scope="col">Actions</th>
              </tr>
            </thead>
            <tbody id="importedARCTable">
            </tbody>
          </table>
        </div>
        <div class="col-7">

         
        </div>
      </div>
      <div id="ARCInfo" class="row m-auto">

      </div>


    </div>
    <div name="tab" class=" col-8 d-none align-items-center m-auto" id="updateTab">

      <div class=" area uploadarea my-3" id="importArea" ondragenter="this.className='area uploadarea dragging'"
        ondrop=";DragAndDrop(event)" style=" width:100%">


        <input type="file" id="import" multiple>
      </div>
      <div class="text-center m-auto">
        <button class="text btn btn-primary d-none" id="toSubmit" onclick="location.href=location.href.split('#')[0]+'#submit'" > 
          Start Submission
        </button>
      </div>
      <div id="alertPlace"> </div>
      
      
    </div>
  </div>
  <button type="button" class="btn btn-primary d-none" id="loadingModalBtn" data-bs-toggle="modal"
    data-bs-target="#loadingModal">
    Launch loading modal
  </button>
  <div class="modal" id="loadingModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
    aria-labelledby="#loadingModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="loadingModalLabel">Processing</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="d-flex justify-content-center">
            <div class="spinner-border" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>


          </div>
          <span id="pbarLabel"> </span>
          <div class="progress">
            <div class="progress-bar progress-bar-striped progress-bar-animated" id="pbarModal" role="progressbar"
              aria-label="Animated striped example" aria-valuenow="1" aria-valuemin="0" aria-valuemax="100"
              style="width: 1%">
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>

        </div>
      </div>
    </div>
  </div>
  <script type="text/javascript">
    var fs = FS.fs;
    var elabJSON;

    async function fetchElabJSON( elabToken, query='experiments/',  corsproxy ='https://cors-anywhere.herokuapp.com/', elabURL = 'https://demo.elabftw.net/api/v2/'){

      // Define the API endpoint
      const elabftwServerUrl = corsproxy + elabURL + query;

      // Define the API key
      
      const headers = {'accept': 'application/json', 'Authorization': elabToken, 'Origin': 'null'};
      // Make the fetch request
      
      try {
       const response = await fetch(elabftwServerUrl, { headers, method: 'GET'});
       const json = await response.json();
       return json;

      } catch (error) {
        alert("Access of eLabFTW is not successful, error message is "+ error)
      }

    }
    async function fetchElabFiles( elabToken, query='experiments/',  corsproxy ='https://cors-anywhere.herokuapp.com/', elabURL = 'https://demo.elabftw.net/api/v2/'){

      // Define the API endpoint
      const elabftwServerUrl = corsproxy + elabURL + query;

      // Define the API key

      const headers = {'accept': 'application/json', 'Authorization': elabToken, 'Origin': 'null'};
      // Make the fetch request

      try {
      var response = await fetch(`${elabftwServerUrl}`, { headers, method: 'GET'});
      return response.blob();

      } catch (error) {
        alert("Access of eLabFTW is not successful, error message is "+ error)
      }

      }
    

  
    //fs.writeFileSync(path+name+"."+extension, content);


    async function datahubClone(datahubURL, dir, datahubtoken){
      const [begin, end] = datahubURL.split("//");
      url = begin + "//oath2:" + datahubtoken + "@" + end;
          console.log(url);
      const cloneResponse = await git.clone({
          fs,
          http,
          dir,
          corsProxy: 'https://cors.isomorphic-git.org',
          url: url,
          ref: 'main',
          singleBranch: true,
          depth: 10,
          force: true,
          onProgress: event => {
            updateLabel(event.phase)
            if (event.total) {
              updateProgressBar(event.loaded / event.total)
            } else {
              updateIndeterminateProgressBar(event.loaded)
            }
          }
        });

    }
    async function updateAll(){
      const expid = document.getElementById("elabexperimentid").value;
      const elabtoken = document.getElementById("elabToken").value;
      const datahubtoken = document.getElementById("datahubToken").value;
      var res = await fetchElabJSON(elabtoken, "experiments/"+expid);
      let extra_fields;
      let datahubURL;
      let studyId;
      try {
        const metadata = JSON.parse(res.metadata);
        extra_fields = metadata.extra_fields
        datahubURL = extra_fields.datahub_url.value;
        studyId = extra_fields.study_id.value;
      } catch (error) {
        alert("please check the extra_fields in your elabFTW experiment" + error);

      };
      
      console.log("datahubURL: "+datahubURL);
      let dir ="arc";
      await datahubClone(datahubURL, dir, datahubtoken);

      await fs.promises.writeFile('arc/studies/'+studyId+'/protocols/protocol.html' , res.body);
      await git.add({ fs, dir: 'arc', filepath: 'studies/'+studyId+'/protocols/protocol.html' })
      const uploads = res.uploads;
      let fileList = [];
      for (const [index, ele] of Object.entries(uploads)){

        const blobs = await fetchElabFiles( elabtoken, "experiments/"+ expid+ "/uploads/"+ ele.id +"?format=´binary´");
        let data = new Uint8Array(await blobs.arrayBuffer());
        // const extension = blobs.type.split("/").slice(-1)[0];
        const path = "arc/assays/"+index+"_"+res.uploads[index].real_name;
        await fs.promises.writeFile(path , data);
        await git.add({ fs, dir: '/', filepath: path })
        }

        console.log('done')
        let sha = await git.commit({
          fs,
          dir: '/arc',
          author: {
            name: 'elab2arc',
            email: 'x.zhou@fz-juelich.de',
          },
          message: 'Testing automatic update tool elab2arc, add all'
        })


        let pushResult = await git.push({
          fs,
          http,
          dir: '/arc',
          remote: 'origin',
          ref: 'main',
          onAuth: () => ({ username: datahubtoken }),
        });
        console.log(pushResult)  ;
      
      
    }

    addEventListener("hashchange", (event) => {

    if (true) {
      softRoute();
    }

    });
      
    const loading = new bootstrap.Modal(document.getElementById('loadingModal'), {
      keyboard: true, show: false
    });

    addEventListener("load", (event) => {try{var repoList;
      softRoute();
    fetch('https://git.nfdi4plants.org/api/v4/projects')
      .then(data => {
        if (data.status >= 400 && data.status < 600) {
      throw alert("Bad response from server, please check the availability of the server");
        }
        return data.json();
      })
      .then(post => {
        window.repoList = post;
        var tableHTML = '';
        let newIndex = 0;
        
        post.forEach((element, index) => {
          if (element.description !== null) {


            const pathName = element.path_with_namespace.split("/");
            newIndex += 1;
            tableHTML += `
        <tr>
          <th scope="row">`+ newIndex + ` </th>
          <td>
          `+ pathName[0] + `
            </td>
             <td>
          <a href="`+ element.web_url + `" target="_blank">` + pathName[1] + `</a>
            </td>
             <td>
              <div class="btn-group" role="group" aria-label="Basic example">
          
          <button type="button" onclick="document.getElementById('repoURL').value='`+ element.http_url_to_repo + `'; cloneARC(false)" class="btn btn-secondary">Import ARC</button>  
          </div>
          </td>
        </tr>
        `
          }
        }), document.getElementById("datahubTable").innerHTML = tableHTML;
      }).catch((error) => {
          // Your error is here!
          alert(error)
        });}catch(e){
        alert(e);
      }});

      

      function softRoute() {
      const urlRoute = window.location.href.split("#");
      const para = urlRoute.slice(-1)[0];
      switch (para) {
        case "elab":
          document.querySelectorAll('div[name="tab"]').forEach((e) => {
            if (e.id == "elabTab") { e.classList.remove("d-none") }
            else { e.classList.add("d-none") }
          }

          )
          break;
        case "arc":
          document.querySelectorAll('div[name="tab"]').forEach((e) => {
            if (e.id == "arcTab") { e.classList.remove("d-none") }
            else { e.classList.add("d-none") }
          }

          )
          break;
        case "submit":
          document.querySelectorAll('div[name="tab"]').forEach((e) => {
            if (e.id == "updateTab") { e.classList.remove("d-none") }
            else { e.classList.add("d-none") }
          }

          )
          break;
          case "":
          document.querySelectorAll('div[name="tab"]').forEach((e) => {
            if (e.id == "elabTab") { e.classList.remove("d-none") }
            else { e.classList.add("d-none") }
          }

          )
          break;
        default:
          

      }

    }

    async function cloneARC(convert = true) {
      try {
        document.getElementById("loadingModalBtn").click();
        var url;
        const token = document.getElementById("gitpassword").value;
        if (!token) {
          url = document.getElementById("repoURL").value;
          console.log(url)
        } else {
          [begin, end] = document.getElementById("repoURL").value.split("//")
          url = begin + "//oath2:" + token + "@" + end;
          console.log(url);
        }
        let date = Date().replaceAll(" ", "_").replaceAll(":", "-").split("(")[0];
        let dir = "/" + url.split("/").slice(-1)[0] + date
        FS.mkdirSync(dir);
        window.current_file = dir;
        const res = await git.clone({
          fs,
          http,
          dir,
          corsProxy: 'https://cors.isomorphic-git.org',
          url: url,
          ref: 'main',
          singleBranch: true,
          depth: 1,
          force: true,
          onProgress: event => {
            updateLabel(event.phase)
            if (event.total) {
              updateProgressBar(event.loaded / event.total)
            } else {
              updateIndeterminateProgressBar(event.loaded)
            }
          }
        });
        let tableHTML="";
        const fileList = fs.readdirSync("/");
        fileList.forEach((element, index) => {
          if (!element.endsWith(".json")){
            const fileName = element.split(".git");
          tableHTML += `
                <tr>
                <td>
              `+ fileName[0] + `
                </td>
                <td>
             `+ fileName[1] + `
                </td>
                <td>  
              <button type="button" onclick=" runARC2JSON('`+ element + `')" class="btn btn-primary"> Update ARC </button>
              </td>
            </tr>
            `
          }
          
        });
        document.getElementById("importedARCTable").innerHTML= tableHTML;
        if (convert) {
         
        }
      } catch (error) {
        document.getElementById("a2jNavBtn").click();
        throw alert(error),
        console.error(error);
      }

      loading.hide();

    }
    function updateLabel(phrase) {
      document.getElementById("pbarLabel").innerHTML = phrase;
    }
    function updateProgressBar(progress) {

      const pbar = document.getElementById("pbarModal");
      pbar.setAttribute("style", 'width:' + progress + '%;')
      pbar.setAttribute("aria-valuenow", progress)
    }
    function updateIndeterminateProgressBar(progress) {

      const pbar = document.getElementById("pbarModal");
      pbar.setAttribute("style", 'width:' + progress + '%;')
      pbar.setAttribute("aria-valuenow", progress)
    }
  </script>


  <!--Modal for submission-->
  <div class="modal fade" id="cModal" tabindex="-1" data-bs-backdrop="static" aria-labelledby="cModalLabel"
    aria-hidden="true" style="z-index:1001">
    <div class="modal-dialog modal-xl modal-fullscreen-xl-down">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="cModalLabel">Upload to Endpoint Repositories</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="container">

            <div class="form-check" id="submitRepos">
              
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" value="1" id="biosamples" name="repo" checked>
                      <label class="form-check-label" for="biosamples">
                        Fetch eLabFTW 

                      </label>


                    </div>
                    <div class="spinner-border text-primary d-none" id="biosamplesloading" role="status">
                      <span class="visually-hidden">Loading...</span>
                    </div>




                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" value="" id="ena" name="repo">
                      <label class="form-check-label" for="ENA">
                        Clone ARC
                      </label>
                    </div>
                    <div class="spinner-border text-primary d-none" id="ENAloading" role="status">
                      <span class="visually-hidden">Loading...</span>
                    </div>



                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" value="" id="metabolights" name="repo">
                      <label class="form-check-label" for="metabolights">
                        Update ARC and Resubmit
                      </label>
                    </div>


                    <div class="spinner-border text-primary d-none" id="metabolightsloading" role="status">
                      <span class="visually-hidden">Loading...</span>
                    </div>


              </div>


            
          </div>
          <table id="validate_table" class="table table-bordered table-hover">

          </table>

        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">download updated JSON</button>
          <button type="button" class="btn btn-primary"
            onclick="Array.from(document.querySelectorAll('input[name=repo]:checked')).forEach((e)=> submitAll(e.id, window.input_json)) ">Submit</button>
        </div>
      </div>
    </div>
  </div>

</body>
<script>

</script>

</html>